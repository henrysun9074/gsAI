# Import all packages 

```{r}
library(pryr)
library(tidyverse)
library(rrBLUP)
library(BGLR)
library(BWGS)
library(qqman)
library(readxl)
library(genetics)
library(corrplot)
library(writexl)
```

```{r}

setwd("/work/tfs3/gsAI/")

### Update paths for current runs! ###########################################
load("/work/tfs3/gsAI/4paul/cv_parallel.RData")

ml_models_path <- "/work/tfs3/gsAI/gebvs/sep05_GEBVs_10foldCV.csv"
r_models_path <- "/work/tfs3/gsAI/4paul/CrossValDarpaGebv.xlsx"
ml_metrics_path <- "/work/tfs3/gsAI/gebvs/sep11_fold_metrics.csv"
# r_metrics_path <- "TBA"

DARPAGEBV <- read.csv(ml_models_path) 
DARPAGEBV2 <- read_xlsx(r_models_path) 
df <- merge(DARPAGEBV, DARPAGEBV2)
write.csv(df, file = ml_models_path, row.names = FALSE)

MLMETRICS <- read.csv(ml_metrics_path) 
# RMETRICS <- read.csv(r_metrics_path) 
# df <- merge(DARPAGEBV, DARPAGEBV2)
MLMETRICS
###############################################################################

```


```{r}

cat("Correlations with Status:\n")
cat("GBLUP: ", cor(DARPAGEBV2$GBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LASSO: ", cor(DARPAGEBV2$LASSO_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RKHS: ",  cor(DARPAGEBV2$RKHS_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("EGBLUP:", cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BRR:   ", cor(DARPAGEBV2$BRR_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BayesB:", cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LR:", cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RF:   ", cor(DARPAGEBV$RF, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("GB:", cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs"), "\n")

cor_df <- data.frame(
  Model = c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB", "LR", "RF", "GB"),
  Correlation = c(
    cor(DARPAGEBV2$GBLUP_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$LASSO_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$RKHS_Mean,   DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BRR_Mean,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$RF,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs")
  )
)

# Barchart
ggplot(cor_df, aes(x = Model, y = Correlation)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  labs(
    y = "Correlation",
    x = "Model"
  ) +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r}
# corrplot
Pairwise <- df[, c("GBLUP_Mean", "LASSO_Mean", "RKHS_Mean", 
                   "EGBLUP_Mean", "BRR_Mean", "BayesB_Mean",
                   "LR", "RF", "GB")]

colnames(Pairwise) <- c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB",
                        "LR", "RF", "GB")
cor_matrix <- cor(Pairwise, use = "complete.obs")

# Plot correlation heatmap
corrplot(cor_matrix, 
         method = "color", 
         type = "upper", 
         tl.cex = 1.0, 
         tl.col = "black",        # axis text color
         addCoef.col = "black",   # numeric labels color
         number.cex = 0.7,
         order = "hclust",        # hierarchical clustering
         addrect = 2,             # draw rectangles around clusters
         title = "Comparison of Genomic Prediction Models for Status",
         mar = c(0,0,2,0))

```

```{r}
metrics_summary <- MLMETRICS %>%
  group_by(model) %>%
  summarise(
    mean_PearsonR = mean(PearsonR, na.rm = TRUE),
    sd_PearsonR   = sd(PearsonR, na.rm = TRUE),
    .groups = "drop"
  )

# Plot
ggplot(metrics_summary, aes(x = model, y = mean_PearsonR)) +
  geom_point() +
  geom_errorbar(aes(
    ymin = mean_PearsonR - sd_PearsonR,
    ymax = mean_PearsonR + sd_PearsonR
  ), width = 0.2) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Model",
    y = "Correlation"
  )

```

