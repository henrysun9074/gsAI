# Import all packages 

```{r warning=FALSE}
library(pryr)
library(tidyverse)
library(rrBLUP)
library(BGLR)
library(BWGS)
library(qqman)
library(readxl)
library(genetics)
library(corrplot)
library(writexl)
```

Very rudimentary visualizations of model performance. Will make new R file eventually 
to make nicer figures with results.

```{r}

setwd("/work/tfs3/gsAI/")

## Update paths for current runs! ###########################################
load("/work/tfs3/gsAI/4paul/gebvs/Oct01_CV_noQCAllGens.RData")
# these correlations are for run done on 10/1. w/o QC, all gens.

ml_models_path <- "/work/tfs3/gsAI/gebvs/oct04_GEBVs_10foldCV.csv"
r_models_path <- "/work/tfs3/gsAI/4paul/gebvs/Oct01_CrossValDarpaGebv_noQC.xlsx"
ml_metrics_path <- "/work/tfs3/gsAI/gebvs/oct04_fold_metrics.csv"
r_metrics_path <- "/work/tfs3/gsAI/4paul/gebvs/Oct01_CrossValDarpaFoldMetrics.csv"

DARPAGEBV <- read.csv(ml_models_path) 
DARPAGEBV2 <- read_xlsx(r_models_path) 
df <- merge(DARPAGEBV, DARPAGEBV2)

MLMETRICS <- read.csv(ml_metrics_path) 
RMETRICS <- read.csv(r_metrics_path)
# stats_df <- merge(MLMETRICS, RMETRICS)

## Turn on to overwrite ML GEBV CSV and add R MODEL VALUES
# write.csv(df, file = ml_models_path, row.names = FALSE)
###############################################################################

```

```{r}
## RUN THIS CODE CHUNK FOR 1 GEN DATA TO FILTER OUT EXTRA ROWS
DARPAGEBV2_filtered <- DARPAGEBV2 %>%
  semi_join(DARPAGEBV, by = "ID")
DARPAGEBV2 <- DARPAGEBV2_filtered
```

```{r}

cat("Correlations with Status:\n")
cat("GBLUP: ", cor(DARPAGEBV2$GBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LASSO: ", cor(DARPAGEBV2$LASSO_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RKHS: ",  cor(DARPAGEBV2$RKHS_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("EGBLUP:", cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BRR:   ", cor(DARPAGEBV2$BRR_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BayesB:", cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LR:", cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RF:   ", cor(DARPAGEBV$RF, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("GB:", cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs"), "\n")

cor_df <- data.frame(
  Model = c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB", "LR", "RF", "GB"),
  Correlation = c(
    cor(DARPAGEBV2$GBLUP_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$LASSO_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$RKHS_Mean,   DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BRR_Mean,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$RF,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs")
  )
)

# Barchart
ggplot(cor_df, aes(x = Model, y = Correlation)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  labs(
    y = "Correlation",
    x = "Model"
  ) +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r}
# corrplot
Pairwise <- df[, c("GBLUP_Mean", "LASSO_Mean", "RKHS_Mean", 
                   "EGBLUP_Mean", "BRR_Mean", "BayesB_Mean",
                   "LR", "RF", "GB")]

colnames(Pairwise) <- c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB",
                        "LR", "RF", "GB")
cor_matrix <- cor(Pairwise, use = "complete.obs")

# Plot correlation heatmap
corrplot(cor_matrix, 
         method = "color", 
         type = "upper", 
         tl.cex = 1.0, 
         tl.col = "black",        # axis text color
         addCoef.col = "black",   # numeric labels color
         number.cex = 0.7,
         order = "hclust",        # hierarchical clustering
         addrect = 2,             # draw rectangles around clusters
         title = "Comparison of Genomic Prediction Models for Status",
         mar = c(0,0,2,0))

```


```{r}
if (!"iteration" %in% names(MLMETRICS)) {
  MLMETRICS <- MLMETRICS %>%
    group_by(model) %>%
    mutate(iteration = rep(1:ceiling(n() / 10), each = 10, length.out = n())) %>%
    ungroup()
}

# Compute per-iteration means for the metrics of interest
per_iter <- MLMETRICS %>%
  group_by(model, iteration) %>%
  summarise(
    auc_iter = mean(AUC, na.rm = TRUE),
    corr_iter = mean(PearsonR, na.rm = TRUE),
    .groups = "drop"
  )

# From the per-iteration means compute overall mean (mean of the iteration means)
# and SD across iteration means (this SD will be used for the error bars)
summary_by_model <- per_iter %>%
  pivot_longer(cols = c(auc_iter, corr_iter), names_to = "metric", values_to = "iter_mean") %>%
  group_by(model, metric) %>%
  summarise(
    mean_of_iters = mean(iter_mean, na.rm = TRUE),   # single point to plot
    sd_of_iters   = sd(iter_mean, na.rm = TRUE),     # used for error bars
    n_iters       = n(),
    .groups = "drop"
  )

# Print table so you can inspect numbers
print(summary_by_model)

ggplot(summary_by_model, aes(x = model, y = mean_of_iters, color = model)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_of_iters - sd_of_iters, ymax = mean_of_iters + sd_of_iters),
                width = 0.2, size = 0.8) +
  facet_wrap(~ metric, scales = "free_y", labeller = as_labeller(c(auc_iter = "AUC", corr_iter = "Correlation"))) +
  labs(
    x = "Model",
    y = "Metric value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

```{r}

RMETRICS <- RMETRICS %>%
  group_by(Model) %>%
  mutate(iteration = rep(1:ceiling(n() / 10), each = 10, length.out = n())) %>%
  ungroup()

# Compute per-iteration means for the metrics of interest
per_iter <- RMETRICS %>%
  group_by(Model, Iteration) %>%
  summarise(
    auc_iter = mean(AUC, na.rm = TRUE),
    corr_iter = mean(Correlation, na.rm = TRUE),
    .groups = "drop"
  )

# From the per-iteration means compute overall mean (mean of the iteration means)
# and SD across iteration means (this SD will be used for the error bars)
summary_by_model <- per_iter %>%
  pivot_longer(cols = c(auc_iter, corr_iter), names_to = "metric", values_to = "iter_mean") %>%
  group_by(Model, metric) %>%
  summarise(
    mean_of_iters = mean(iter_mean, na.rm = TRUE),   # single point to plot
    sd_of_iters   = sd(iter_mean, na.rm = TRUE),     # used for error bars
    n_iters       = n(),
    .groups = "drop"
  )

# Print table so you can inspect numbers
print(summary_by_model)

ggplot(summary_by_model, aes(x = Model, y = mean_of_iters, color = Model)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_of_iters - sd_of_iters, ymax = mean_of_iters + sd_of_iters),
                width = 0.2, size = 0.8) +
  facet_wrap(~ metric, scales = "free_y", labeller = as_labeller(c(auc_iter = "AUC", corr_iter = "Correlation"))) +
  labs(
    title = "Mean across all folds & iterations (point) with SD across iterations (error bar)",
    x = "Model",
    y = "Metric value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

Todo:
- plot SD of repetitions

