# Import all packages 

```{r warning=FALSE echo=FALSE}
library(pryr)
library(tidyverse)
library(rrBLUP)
library(BGLR)
library(BWGS)
library(qqman)
library(readxl)
library(genetics)
library(corrplot)
library(writexl)
```

Very rudimentary visualizations of model performance. Will make new R file eventually 
to make nicer figures with results.

```{r}

setwd("/work/tfs3/gsAI/")

## Update paths for current runs! ###########################################
# load("/work/tfs3/gsAI/4paul/gebvs/Oct01_CV_noQCAllGens.RData")
# these correlations are for run done on 10/1. w/o QC, all gens.

ml_models_path <- "/work/tfs3/gsAI/gebvs/Oct08_allnoqc_GEBVs_10foldCV.csv"
r_models_path <- "/work/tfs3/gsAI/4paul/gebvs/Oct01_CrossValDarpaGebv_noQC.xlsx"
ml_metrics_path <- "/work/tfs3/gsAI/gebvs/Oct08_allnoqc_fold_metrics.csv"
r_metrics_path <- "/work/tfs3/gsAI/4paul/gebvs/Oct01_CrossValDarpaFoldMetrics.csv"

DARPAGEBV <- read.csv(ml_models_path) 
DARPAGEBV2 <- read_xlsx(r_models_path) 
df <- merge(DARPAGEBV, DARPAGEBV2)

MLMETRICS <- read.csv(ml_metrics_path) 
RMETRICS <- read.csv(r_metrics_path)
names(RMETRICS) <- tolower(names(RMETRICS))
names(MLMETRICS) <- tolower(names(MLMETRICS))
MLMETRICS <- MLMETRICS %>%
  rename(correlation = pearsonr)
RMETRICS <- RMETRICS %>%
  mutate(model=dplyr::recode(model, "BL" = "LASSO"))

if (!"iteration" %in% names(MLMETRICS)) {
  MLMETRICS <- MLMETRICS %>%
    group_by(model) %>%
    mutate(iteration = rep(1:10, each = 5, length.out = n())) %>%
    ungroup()
}
allMetrics <- rbind(MLMETRICS, RMETRICS)

## Turn on to overwrite ML GEBV CSV and add R MODEL VALUES
# write.csv(df, file = ml_models_path, row.names = FALSE)
###############################################################################

```

```{r}
## RUN THIS CODE CHUNK FOR 1 GEN DATA TO FILTER OUT EXTRA ROWS
DARPAGEBV2_filtered <- DARPAGEBV2 %>%
  semi_join(DARPAGEBV, by = "ID")
DARPAGEBV2 <- DARPAGEBV2_filtered

DARPAGEBV_filtered <- DARPAGEBV %>%
  semi_join(DARPAGEBV2, by = "ID")
DARPAGEBV <- DARPAGEBV_filtered
```

```{r}

cat("Correlations with Status:\n")
cat("GBLUP: ", cor(DARPAGEBV2$GBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LASSO: ", cor(DARPAGEBV2$LASSO_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RKHS: ",  cor(DARPAGEBV2$RKHS_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("EGBLUP:", cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BRR:   ", cor(DARPAGEBV2$BRR_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("BayesB:", cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("LR:", cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("RF:   ", cor(DARPAGEBV$RF, DARPAGEBV2$Status, use = "complete.obs"), "\n")
cat("GB:", cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs"), "\n")

cor_df <- data.frame(
  Model = c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB", "LR", "RF", "GB"),
  Correlation = c(
    cor(DARPAGEBV2$GBLUP_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$LASSO_Mean,  DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$RKHS_Mean,   DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$EGBLUP_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BRR_Mean,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV2$BayesB_Mean, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$LR, DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$RF,    DARPAGEBV2$Status, use = "complete.obs"),
    cor(DARPAGEBV$GB, DARPAGEBV2$Status, use = "complete.obs")
  )
)

# Barchart
ggplot(cor_df, aes(x = Model, y = Correlation)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  labs(
    y = "Correlation",
    x = "Model"
  ) +
  theme(
    text = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r}
# corrplot
Pairwise <- df[, c("GBLUP_Mean", "LASSO_Mean", "RKHS_Mean", 
                   "EGBLUP_Mean", "BRR_Mean", "BayesB_Mean",
                   "LR", "RF", "GB")]

colnames(Pairwise) <- c("GBLUP", "LASSO", "RKHS", "EGBLUP", "BRR", "BayesB",
                        "LR", "RF", "GB")
cor_matrix <- cor(Pairwise, use = "complete.obs")

# Plot correlation heatmap
corrplot(cor_matrix, 
         method = "color", 
         type = "upper", 
         tl.cex = 1.0, 
         tl.col = "black",        # axis text color
         addCoef.col = "black",   # numeric labels color
         number.cex = 0.7,
         order = "hclust",        # hierarchical clustering
         addrect = 2,             # draw rectangles around clusters
         title = "Comparison of Genomic Prediction Models for Status",
         mar = c(0,0,2,0))

```


```{r}
library(RColorBrewer)

per_iter <- allMetrics %>%
  group_by(model, iteration) %>%
  summarise(
    auc_iter = mean(auc, na.rm = TRUE),
    corr_iter = mean(correlation, na.rm = TRUE),
    .groups = "drop"
  )

# From the per-iteration means compute overall mean (mean of the iteration means)
# and SD across iteration means (this SD will be used for the error bars)
summary_by_model <- per_iter %>%
  pivot_longer(cols = c(auc_iter, corr_iter), names_to = "metric", values_to = "iter_mean") %>%
  group_by(model, metric) %>%
  summarise(
    mean_of_iters = mean(iter_mean, na.rm = TRUE),   # single point to plot
    sd_of_iters   = sd(iter_mean, na.rm = TRUE),     # used for error bars
    n_iters       = n(),
    .groups = "drop"
  )

# Print table so you can inspect numbers
print(summary_by_model)

ggplot(summary_by_model, aes(x = model, y = mean_of_iters, color = model)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_of_iters - sd_of_iters, ymax = mean_of_iters + sd_of_iters),
                width = 0.8, size = 0.5) +
  facet_wrap(~ metric, scales = "free_y", labeller = as_labeller(c(auc_iter = "AUC", corr_iter = "Correlation"))) +
  # scale_color_brewer(palette = "Dark2") +
  # labs(
  #   x = "Model",
  #   y = "Metric value") +
  theme_classic() +
  theme(axis.text.x = element_blank()) +
  theme(axis.title = element_blank())
  theme(panel.grid.major.x = element_blank())
```

```{r}

if (!"iteration" %in% names(MLMETRICS)) {
  MLMETRICS <- MLMETRICS %>%
    group_by(model) %>%
    mutate(iteration = rep(1:10, each = 5, length.out = n())) %>%
    ungroup()
}

# Compute per-iteration means for the metrics of interest
per_iter <- MLMETRICS %>%
  group_by(model, iteration) %>%
  summarise(
    auc_iter = mean(auc, na.rm = TRUE),
    corr_iter = mean(correlation, na.rm = TRUE),
    .groups = "drop"
  )

# From the per-iteration means compute overall mean (mean of the iteration means)
# and SD across iteration means (this SD will be used for the error bars)
summary_by_model <- per_iter %>%
  pivot_longer(cols = c(auc_iter, corr_iter), names_to = "metric", values_to = "iter_mean") %>%
  group_by(model, metric) %>%
  summarise(
    mean_of_iters = mean(iter_mean, na.rm = TRUE),   # single point to plot
    sd_of_iters   = sd(iter_mean, na.rm = TRUE),     # used for error bars
    n_iters       = n(),
    .groups = "drop"
  )

# Print table so you can inspect numbers
print(summary_by_model)

ggplot(summary_by_model, aes(x = model, y = mean_of_iters, color = model)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_of_iters - sd_of_iters, ymax = mean_of_iters + sd_of_iters),
                width = 0.2, size = 0.5) +
  facet_wrap(~ metric, scales = "free_y", labeller = as_labeller(c(auc_iter = "AUC", corr_iter = "Correlation"))) +
  labs(
    x = "Model",
    y = "Metric value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")


RMETRICS <- RMETRICS %>%
  group_by(model) %>%
  mutate(iteration = rep(1:10, each = 5, length.out = n())) %>%
  ungroup()

# Compute per-iteration means for the metrics of interest
per_iter <- RMETRICS %>%
  group_by(model, iteration) %>%
  summarise(
    auc_iter = mean(auc, na.rm = TRUE),
    corr_iter = mean(correlation, na.rm = TRUE),
    .groups = "drop"
  )

# From the per-iteration means compute overall mean (mean of the iteration means)
# and SD across iteration means (this SD will be used for the error bars)
summary_by_model <- per_iter %>%
  pivot_longer(cols = c(auc_iter, corr_iter), names_to = "metric", values_to = "iter_mean") %>%
  group_by(model, metric) %>%
  summarise(
    mean_of_iters = mean(iter_mean, na.rm = TRUE),  
    sd_of_iters   = sd(iter_mean, na.rm = TRUE),  
    n_iters       = n(),
    .groups = "drop"
  )

# Print table so you can inspect numbers
print(summary_by_model)

ggplot(summary_by_model, aes(x = model, y = mean_of_iters, color = model)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_of_iters - sd_of_iters, ymax = mean_of_iters + sd_of_iters),
                width = 0.2, size = 0.5) +
  facet_wrap(~ metric, scales = "free_y", labeller = as_labeller(c(auc_iter = "AUC", corr_iter = "Correlation"))) +
  labs(
    x = "Model",
    y = "Metric value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

## GEBV Visualization

```{r}
# gebv_cols <- c("GBLUP_Mean", "EGBLUP_Mean", "BRR_Mean", "BayesB_Mean",
#                "LASSO_Mean", "RKHS_Mean", "LR", "RF", "GB")
gebv_cols <- c("GBLUP_Mean", "EGBLUP_Mean", "BRR_Mean", "BayesB_Mean",
                "LASSO_Mean", "RKHS_Mean")

df_long <- df %>%
  dplyr::select(gebv_cols) %>%
  tidyr::pivot_longer(cols = everything(),
                      names_to = "Model",
                      values_to = "Value") %>%
  dplyr::mutate(Value = as.numeric(Value))

p_overlay <- ggplot(df_long, aes(x = Value, fill = Model, color = Model)) +
  geom_density(alpha = 0.2) +
  labs(
       x = "GEBV",
       y = "Density") +
  theme_classic(base_size = 14) +
  theme(legend.position = "right")

print(p_overlay)

```

